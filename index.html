<html>
<head>
	<title>Smartphone Controller Game</title>
	<script src="/socket.io/socket.io.js"></script>
	<script src="//davidshimjs.github.com/qrcodejs/qrcode.min.js"></script>
	<script src="//threejs.org/build/three.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/4.0.0/pixi.min.js"></script>
	<style>
		body{
			margin: 0;
		}
		#QR_code{
			position: absolute;
			top: 0;
			padding: 20px;
			background: white;
		}

		#accell {
			font-size:50px;
		}
	</style>
</head>
<body>
<div class="accell">Acceleration</div>
	<div id="accellx" class="accell"></div>
	<div id="accelly" class="accell"></div>
	<div id="accellz" class="accell"></div>
	<br />
	<br />
	<div class="accell">Acceleration Including Gravity</div>
	<div id="accellGravx" class="accell"></div>
	<div id="accellGravy" class="accell"></div>
	<div id="accellGravz" class="accell"></div>
	<br />
	<br />
	<div class="accell">Rotation</div>
	<div id="rotationx" class="accell"></div>
	<div id="rotationy" class="accell"></div>
	<div id="rotationz" class="accell"></div>
</body>
<script>
var ip = '192.168.167.130', // Your ip
		port = ':2000',
		io = io.connect(),
		current_url = window.location.href;
io.on('connect', function() {
	// Game setup
	var game = function(ip){
		var QR_code_element,
		create_QR = function(){
			var QR_code,
					url = "http://" + ip + port + "?id=" + io.id;
			// Create the container for the QR code to be created in
			QR_code_element = document.createElement('div');
			// Assign an id to the element
			QR_code_element.id = "QR_code";
			// Append QR code element to the body
			document.body.appendChild(QR_code_element);
			// Assign the actual DOM element
			QR_code_element = document.getElementById('QR_code');
			// Create a QRCode
			QR_code = new QRCode("QR_code");
			QR_code.makeCode(url);
		},
		makeCat = function(){
			var renderer = PIXI.autoDetectRenderer(
				1000, 1000,
				{antialias: false, transparent: false, resolution: 1}
				);

			//Add the canvas to the HTML document
			document.body.appendChild(renderer.view);

			//Create a container object called the `stage`
			var stage = new PIXI.Container();

			renderer.backgroundColor = 0x061639;

			renderer.view.style.position = "absolute";
			renderer.view.style.display = "block";
			renderer.autoResize = true;
			renderer.resize(window.innerWidth, window.innerHeight);

			//Use Pixi's built-in `loader` object to load an image
			PIXI.loader
			  .add("images/cat.png")
			  .load(setup);

			//This `setup` function will run when the image has loaded
			function setup() {

			  //Create the `cat` sprite from the texture
			  var cat = new PIXI.Sprite(
			    PIXI.loader.resources["/images/cat.png"].texture
			  );

			  //Change the sprite's position
			  cat.x = window.innerWidth / 2;
			  cat.y = window.innerHeight / 2;

			  //Add the cat to the stage
			  stage.addChild(cat);

			  //Render the stage   
			  renderer.render(stage);
			}
		},
		game_connected = function(){
			makeCat();
			create_QR();
			io.removeListener('game_connected', game_connected);
		}
		// Tell the server that the client is connecting as a game
		io.emit('game_connect');
		// When the server has registered this client as a game
		// Create a QR code which will be a url with this game id as a parameter
		io.on('game_connected', game_connected);
		// When a controller has connected/disconnected to this game
		io.on('controller_connected', function(connected){
			if(connected){
				// Hide the QR code
				QR_code_element.style.display = "none";
			}else{
				// Show the QR code
				QR_code_element.style.display = "block";
				controller_state = {};
			}
		})
		// When the server sends a changed controller state update it in the game
		io.on('controller_state_change', function(state){
			controller_state = state;
		});
	},
	// Controller set up
	controller = function(game_id){
		// Tell the server this client is connecting as a controller
		// sending the id of the game to connect to
		io.emit('controller_connect', game_id);
		// Server will send back a connected boolean
		io.on('controller_connected', function(connected){
			if(connected){
				// Successful connection
				alert("Connected!");
				var controller_state = {
					accelerate: false,
					steer: 0
				},
				emit_updates = function(){
					io.emit('controller_state_change', controller_state);
				}
				touchstart = function(e){
					e.preventDefault();
					controller_state.accelerate = true;
					emit_updates();
				},
				touchend = function(e){
					e.preventDefault();
					controller_state.accelerate = false;
					emit_updates();
				},
				devicemotion = function(e){
					controller_state.steer = e.accelerationIncludingGravity.y / 100;

					controllerx = Math.round(e.acceleration.x * 100);
					controllery = Math.round(e.acceleration.y * 100);
					controllerz = Math.round(e.acceleration.z * 100);
					document.getElementById("accellx").innerHTML = "X-acceleration: " + controllerx;
					document.getElementById("accelly").innerHTML = "Y-acceleration: " + controllery;
					document.getElementById("accellz").innerHTML = "Z-acceleration: " + controllerz;

					controllerIncludingGravityx = Math.round(e.accelerationIncludingGravity.x);
					controllerIncludingGravityy = Math.round(e.accelerationIncludingGravity.y);
					controllerIncludingGravityz = Math.round(e.accelerationIncludingGravity.z);
					document.getElementById("accellGravx").innerHTML = "X-accelerationIncludingGravity: " + controllerIncludingGravityx;
					document.getElementById("accellGravy").innerHTML = "Y-accelerationIncludingGravity: " + controllerIncludingGravityy;
					document.getElementById("accellGravz").innerHTML = "Z-accelerationIncludingGravity: " + controllerIncludingGravityz;

					rotationx = Math.round(e.rotation.x);
					rotationy = e.rotation.y;
					rotationz = e.rotation.z;
					document.getElementById("rotationx").innerHTML = "X-rotation: " + rotationx;
					document.getElementById("rotationy").innerHTML = "Y-rotation: " + rotationy;
					document.getElementById("rotationz").innerHTML = "Z-rotation: " + rotationz;
					emit_updates();
				}
				document.body.addEventListener('touchstart', touchstart, false); // iOS & Android
				document.body.addEventListener('MSPointerDown', touchstart, false); // Windows Phone
				document.body.addEventListener('touchend', touchend, false); // iOS & Android
				document.body.addEventListener('MSPointerUp', touchend, false); // Windows Phone
				window.addEventListener('devicemotion', devicemotion, false);
				window.addEventListener("deviceorientation", handleOrientation, true);
			}else{
				// Failed connection
				alert("Not connected!");
			}
		});
	}
	// If the url has an id in it
	if(current_url.indexOf('?id=') > 0){
		// Set up the controller using the game id in the url
		controller(current_url.split('?id=')[1])
	}else{
		// Set up the game using ip
		game(ip);
	}
});
</script>
</html>