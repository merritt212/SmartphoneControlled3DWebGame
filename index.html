<html>
<head>
	<title>Smartphone Controller Game</title>
	<script src="/socket.io/socket.io.js"></script>
	<script src="//davidshimjs.github.com/qrcodejs/qrcode.min.js"></script>
	<script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
	<style>
		body{
			margin: 0;
		}
		#backgroundimage img {
			width: 100%;
			height: 100%;
		}
		#QR_code{
			position: absolute;
			top: 0;
			padding: 20px;
			background: white;
		}

		#accell {
			font-size:50px;
		}

		#render_square {
			position:absolute;
			top:30%;
			left:40%;
			z-index:99;
		}
		#pinata {
			position:absolute;
			top:30%;
			left:30%;
			z-index:1;
		}
		#left {
			position: absolute;
			top:0;
			left:500px;
		}
		#right {
			position: absolute;
			top:0;
			left:600px;
		}
		#up {
			position: absolute;
			top:0;
			left:700px;
			font-family: arial, sans-serif;
			font-size:40px;
		}
		#down {
			position: absolute;
			top:0;
			left:800px;
		}
		#rotate {
			position: absolute;
			top:0;
			left:900px;
		}

		#mobile_btn {
			width:200px;
			height:200px; 
			background-color: green;
			color:white;
			font-size:30px;
		}
	</style>
</head>
<body>
	<div class="accell">Compas Heading</div>
	<div id="heading" class="accell"></div>
	<br />
	<br />
	<div class="accell">Acceleration Including Gravity</div>
	<div id="accellGravx" class="accell"></div>
	<div id="accellGravy" class="accell"></div>
	<div id="accellGravz" class="accell"></div>
	<br />
</body>
<script>
var ip = '192.168.167.130', // Your ip
port = ':2000',
io = io.connect(),
current_url = window.location.href;
io.on('connect', function() {
	
	// Game setup
	var game = function(ip){
		var QR_code_element,

		create_QR = function(){
			var QR_code,
			url = "http://" + ip + port + "?id=" + io.id;
			// Create the container for the QR code to be created in
			QR_code_element = document.createElement('div');
			// Assign an id to the element
			QR_code_element.id = "QR_code";
			// Append QR code element to the body
			document.body.appendChild(QR_code_element);
			// Assign the actual DOM element
			QR_code_element = document.getElementById('QR_code');
			// Create a QRCode
			QR_code = new QRCode("QR_code");
			QR_code.makeCode(url);
		},

		//Show position of Pinata div
		// showPos = function(elem) {
		// 	var r = elem.getBoundingClientRect()
		// 	alert("Top: "+r.top);
		// },

		// When game is connected create the QR code and remove game listener handler
		game_connected = function(){
			create_QR();
			io.removeListener('game_connected', game_connected);
		},

		collision_check = function(div1, div2) {

			div1coords = div1.getBoundingClientRect();
			div2coords = div2.getBoundingClientRect();

			var x1 = div1coords.left;
			var y1 = div1coords.top;
			var h1 = div1coords.right - div1coords.left;
			var w1 = div1coords.bottom - div1coords.top;
			var b1 = y1 + h1;
			var r1 = x1 + w1;
			var x2 = div2coords.left;
			var y2 = div2coords.top;
			var h2 = div2coords.right - div2coords.left;
			var w2 = div2coords.bottom - div2coords.top;
			var b2 = y2 + h2;
			var r2 = x2 + w2;

			if (b1 < y2 || y1 > b2 || r1 < x2 || x1 > r2) return false;
			return true;
		},

		swing_count = 0,

		add_swing_count = function(){
			swings.innerHTML = 'Number of swings: ' + swing_count;
			document.body.appendChild(swings);
		},
		render = function(){

			if(controller_state.swing){
				stick.innerHTML = '<img src="http://visualidentity.cachefly.net/studio/websocket/images/whack.png">';
				document.body.appendChild(stick);
				swing_count ++;
				add_swing_count();
			}
			else{
				stick.innerHTML = '<img src="http://visualidentity.cachefly.net/studio/websocket/images/Big_Stick.png">';
				document.body.appendChild(stick);
			}

			//If hit is detected, take away hit points
			if(collision_check(stick, pinata) && controller_state.swing){
				if (hit_points > 0) {
					hit_points = hit_points - 10;
					damage.innerHTML = 'Hit Points: ' + parseInt(hit_points);
					document.body.appendChild(damage);
				} else {
					stick.innerHTML = '';
					pinata.innerHTML = '';
					document.body.appendChild(pinata);
					document.body.appendChild(stick);
					damage.innerHTML = 'YOU WIN A PRIZE!!!!!!';
				}
			}

			//Current position of stick div
			currentPos = stick.getBoundingClientRect();
			left = currentPos.left;
			up = currentPos.top;

			stick_xpos = controller_state.steerx;
			stick_ypos = controller_state.steery;
			stick_zpos = controller_state.steerz;

            //Move left or right depending on positive or negitive x axis value
            if (stick_xpos >= 270 && stick_xpos < 360) {
            	if (moveLeftRight > (0) && moveLeftRight < (window.innerWidth-stick.offsetWidth)){
            		moveLeftRight = left - 15;
            	} else {
            		moveLeftRight = left + 50;
            	}
            } else if (stick_xpos <= 260 && stick_xpos > 180) {
            	if (moveLeftRight > (0) && moveLeftRight < (window.innerWidth-stick.offsetWidth)){
            		moveLeftRight = left + 15;
            	} else {
            		moveLeftRight = left - 50;
            	}
            }

			//Move up or down depending on positive or negitive y axis value
			if (stick_ypos >= 5 && stick_ypos <= 90) {
				if (moveUpDown > (-(stick.offsetHeight / 2)) && (window.innerHeight - stick.offsetHeight)){
					moveUpDown = up - 15;
				} else {
					moveUpDown = up + 100;
				}
			} else if (stick_ypos <= -2 && stick_ypos > -90) {
				if (moveUpDown < (window.innerHeight - stick.offsetHeight) && moveUpDown > (-(stick.offsetHeight / 2))){
					moveUpDown = up + 15;
				} else {
					moveUpDown = up - 100;
				}
			}

            //Move stick div up, down, left, right
            $stick.css({"top": moveUpDown, "left": moveLeftRight});

            //Rotation of stick

            requestAnimationFrame(render);
        },


        controller_state = {};

        // background = document.createElement("div");
        // background.id = 'backgroundimage';
        // background.innerHTML = '<img src="http://visualidentity.cachefly.net/studio/websocket/images/bullfight.jpg">';
        // document.body.appendChild(background);

		// Set up stick div and populate with img
		stick = document.createElement("div");
		stick.id = 'render_square';
		stick.innerHTML = '<img src="http://visualidentity.cachefly.net/studio/websocket/images/Big_Stick.png">';
		document.body.appendChild(stick);
		// showPos(stick);
		$stick = $(stick);

		currentPos = stick.getBoundingClientRect();
		moveLeftRight = currentPos.left;
		moveUpDown = currentPos.top;

		// Set up Pinata div
		pinata = document.createElement("div");
		pinata.id = 'pinata';
		pinata.innerHTML = '<img src="http://visualidentity.cachefly.net/studio/websocket/images/idhitthat.png">';
		document.body.appendChild(pinata);

		damage = document.createElement("div");
		damage.id = 'up';
		damage.innerHTML = 'Damage: 1000';
		document.body.appendChild(damage);

		swings = document.createElement("div");
		swings.id = 'left';
		swings.innerHTML = 'Number of swings: 0';
		document.body.appendChild(swings);

		hit_points = 1000,

		// This sets off the render loop
		render();

		// Tell the server that the client is connecting as a game
		io.emit('game_connect');

		// When the server has registered this client as a game
		// Create a QR code which will be a url with this game id as a parameter
		io.on('game_connected', game_connected);

		// When a controller has connected/disconnected to this game
		io.on('controller_connected', function(connected){

			if(connected){

				// Hide the QR code
				QR_code_element.style.display = "none";
				// setInitialOrientation();
				//add_swing_count();

			}else{

				// Show the QR code
				QR_code_element.style.display = "block";

				controller_state = {};

			}

		})

		// When the server sends a changed controller state update it in the game
		io.on('controller_state_change', function(state){

			controller_state = state;

		});

	},

	// Controller set up
	controller = function(game_id){

		// Tell the server this client is connecting as a controller
		// sending the id of the game to connect to
		io.emit('controller_connect', game_id);

		// Server will send back a connected boolean
		io.on('controller_connected', function(connected){

			if(connected){

				// Successful connection
				alert("Connected!");

				// Set up variables for controller state
				var controller_state = {
					accelerate: false,
					steerx: 0,
					steery: 0,
					steerz: 0,
					motionx: 0,
					motiony: 0,
					motionz: 0,
					swing: false,
					compassHeading: 0
				},

				emit_updates = function(){
					io.emit('controller_state_change', controller_state);
				},

				touchstart = function(e){
					e.preventDefault();
					
					hit();
					controller_state.accelerate = true;
					emit_updates();
				}

				touchend = function(e){
					e.preventDefault();
					
					controller_state.accelerate = false;
					emit_updates();
				},

				devicemotion = function(e){
					controller_state.motionx = e.acceleration.x * 100;
					controller_state.motiony = e.acceleration.y * 100;
					controller_state.motionz = e.acceleration.z * 100;

					document.getElementById("accellGravx").innerHTML = "X-acceleration: " + controller_state.motionx;
					document.getElementById("accellGravy").innerHTML = "Y-acceleration: " + controller_state.motiony;
					document.getElementById("accellGravz").innerHTML = "Z-acceleration: " + controller_state.motionz;

					emit_updates();
				},

				detect_swing = function(e){
					if(((e.acceleration.z * 100) > 3000 || (e.acceleration.z * 100) < -3000 )){
						controller_state.swing = true;
						console.log("Controller swing true!!");
					} else { 
						controller_state.swing = false;
					}

					emit_updates();
				},

				handleOrientation = function handleOrientation(e) {
                	// Get the orientation of the device
				  // deviceabsolute = e.absolute;
				  controller_state.steerx  = e.alpha;
				  controller_state.steery  = e.beta;
				  controller_state.steerz  = e.gamma;

				  emit_updates();
				},

				compassHeading = function compassHeading(e) {
					console.log("compassHeading");
				  // Convert degrees to radians
				  var alphaRad = e.alpha * (Math.PI / 180);
				  var betaRad = e.beta * (Math.PI / 180);
				  var gammaRad = e.gamma * (Math.PI / 180);

				  // Calculate equation components
				  var cA = Math.cos(alphaRad);
				  var sA = Math.sin(alphaRad);
				  var cB = Math.cos(betaRad);
				  var sB = Math.sin(betaRad);
				  var cG = Math.cos(gammaRad);
				  var sG = Math.sin(gammaRad);

				  // Calculate A, B, C rotation components
				  var rA = - cA * sG - sA * sB * cG;
				  var rB = - sA * sG + cA * sB * cG;
				  var rC = - cB * cG;

				  // Calculate compass heading
				  var compassHeading = Math.atan(rA / rB);

				  // Convert from half unit circle to whole unit circle
				  if(rB < 0) {
				  	compassHeading += Math.PI;
				  }else if(rA < 0) {
				  	compassHeading += 2 * Math.PI;
				  }

				  // Convert radians to degrees
				  compassHeading *= 180 / Math.PI;

				  controller_state.compassHeading = compassHeading;
				  console.log(controller_state.compassHeading);

				  emit_updates();
				},

				hit = function() {
					alert("hit pinata");
				},

				//Window and Body listeners
				document.body.addEventListener('touchstart', touchstart, false); // iOS & Android
				document.body.addEventListener('MSPointerDown', touchstart, false); // Windows Phone
				document.body.addEventListener('touchend', touchend, false); // iOS & Android
				document.body.addEventListener('MSPointerUp', touchend, false); // Windows Phone
				window.addEventListener('devicemotion', devicemotion, false);
				window.addEventListener('devicemotion', detect_swing, false);
				window.addEventListener("deviceorientation", handleOrientation, true);
				window.addEventListener("deviceorientation", compassHeading, true);

			}else{

				// Failed connection
				alert("Not connected!");
			}
		});

	}

	// If the url has an id in it
	if(current_url.indexOf('?id=') > 0){

		// Set up the controller using the game id in the url
		controller(current_url.split('?id=')[1])

	}else{

		// Set up the game using ip
		game(ip);

	}
});

</script>
</html>
